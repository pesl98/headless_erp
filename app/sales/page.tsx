import { supabase } from '@/lib/supabase'
import { StatusBadge } from '@/components/ui/StatusBadge'
import { ShoppingCart, Users, TrendingUp } from 'lucide-react'
export const revalidate = 30
async function getSalesData() {
  const [{ data: salesOrders }, { data: customers }] = await Promise.all([    supabase      .from('erp_sales_orders')      .select('*, erp_customers(customer_name, customer_tier, maximum_credit_limit, current_balance), erp_agents(display_name, avatar_emoji)')      .order('order_creation_date', { ascending: false })      .limit(30),    supabase      .from('erp_customers')      .select('*')      .order('customer_tier', { ascending: false }),  ])
  return { salesOrders: salesOrders ?? [], customers: customers ?? [] }
}
const TIER_ORDER = { platinum: 4, gold: 3, silver: 2, standard: 1 }
export default
async function SalesPage() {
  const { salesOrders, customers } = await getSalesData()
  const totalRevenue = salesOrders.reduce((s, o) => s + Number(o.total_invoice_value), 0)
  const confirmedOrders = salesOrders.filter((o) => o.order_status === 'confirmed').length
  const sortedCustomers = [...customers].sort(    (a, b) =>      (TIER_ORDER[b.customer_tier as keyof typeof TIER_ORDER] ?? 0) -      (TIER_ORDER[a.customer_tier as keyof typeof TIER_ORDER] ?? 0)  )
  return (    <div style={{ padding: '28px 32px', maxWidth: 1400, margin: '0 auto' }}>      {/* Header */}      <div className="anim-fade-up" style={{ marginBottom: 28 }}>        <div className="label" style={{ marginBottom: 6 }}>SALES & CRM</div>        <h1 style={{ fontSize: '1.6rem', fontWeight: 700, color: 'var(--txt-primary)', letterSpacing: '-0.02em', margin: 0 }}>          Orders & Customer Management        </h1>        <p style={{ fontSize: '0.8125rem', color: 'var(--txt-secondary)', marginTop: 5 }}>          Sales agent–driven order processing with credit limit enforcement and customer tier pricing        </p>      </div>      {/* KPI strip */}      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 14, marginBottom: 22 }}>        {[          { label: 'Total Orders', value: salesOrders.length, color: '#3b82f6', icon: <ShoppingCart size={15} /> },          { label: 'Confirmed', value: confirmedOrders, color: '#22c55e', icon: <TrendingUp size={15} /> },          { label: 'Total Invoice Value', value: `€${totalRevenue.toLocaleString('en-EU', { minimumFractionDigits: 2 })}`, color: '#f59e0b', icon: <TrendingUp size={15} /> },        ].map(({ label, value, color, icon }, i) => (          <div key={label} className={`erp-card anim-fade-up anim-delay-${i + 1}`} style={{ padding: '16px 20px', borderColor: `${color}25` }}>            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>              <span className="label">{label}</span>              <span style={{ color }}>{icon}</span>            </div>            <div className="num" style={{ fontSize: '1.6rem', fontWeight: 700, color, letterSpacing: '-0.02em' }}>{value}</div>          </div>        ))}      </div>      <div style={{ display: 'grid', gridTemplateColumns: '1fr 380px', gap: 18 }}>        {/* Sales Orders */}        <div className="erp-card anim-fade-up anim-delay-2">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <ShoppingCart size={13} color="#3b82f6" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Sales Orders            </span>            <span className="label" style={{ marginLeft: 'auto' }}>{salesOrders.length} ORDERS</span>          </div>          <div style={{ overflowX: 'auto' }}>            <table className="erp-table">              <thead>                <tr>                  <th>Order ID</th>                  <th>Customer</th>                  <th>Tier</th>                  <th>Agent</th>                  <th>Status</th>                  <th style={{ textAlign: 'right' }}>Discount</th>                  <th style={{ textAlign: 'right' }}>Value</th>                  <th>Date</th>                </tr>              </thead>              <tbody>                {salesOrders.length === 0 ? (                  <tr>                    <td colSpan={8} style={{ textAlign: 'center', color: 'var(--txt-muted)', padding: '32px 12px' }}>                      No sales orders recorded                    </td>                  </tr>                ) : salesOrders.map((order) => {                
  const customer = (order as Record<string, unknown>).erp_customers as {                    customer_name: string
                    customer_tier: string
                    maximum_credit_limit: number
                    current_balance: number                  } | null                
  const agent = (order as Record<string, unknown>).erp_agents as { display_name: string; avatar_emoji: string } | null                
  return (                    <tr key={order.sales_order_id}>                      <td>                        <span className="mono" style={{ fontSize: '0.7rem', color: 'var(--txt-muted)' }}>                          {order.sales_order_id.slice(0, 8)}…                        </span>                      </td>                      <td>                        <span style={{ fontSize: '0.8125rem', fontWeight: 500, color: '#e2eaf5' }}>                          {customer?.customer_name ?? '—'}                        </span>                      </td>                      <td><StatusBadge status={customer?.customer_tier ?? 'standard'} size="xs" /></td>                      <td>                        <span style={{ fontSize: '0.75rem', color: 'var(--txt-secondary)' }}>                          {agent?.avatar_emoji} {agent?.display_name}                        </span>                      </td>                      <td><StatusBadge status={order.order_status} size="xs" /></td>                      <td style={{ textAlign: 'right' }}>                        <span className="num" style={{ fontSize: '0.8rem', color: Number(order.discount_percent) > 0 ? '#f59e0b' : 'var(--txt-muted)' }}>                          {Number(order.discount_percent) > 0 ? `${Number(order.discount_percent).toFixed(0)}%` : '—'}                        </span>                      </td>                      <td style={{ textAlign: 'right' }}>                        <span className="num" style={{ fontSize: '0.875rem', fontWeight: 600, color: '#3b82f6' }}>                          €{Number(order.total_invoice_value).toLocaleString('en-EU', { minimumFractionDigits: 2 })}                        </span>                      </td>                      <td>                        <span className="mono" style={{ fontSize: '0.7rem', color: 'var(--txt-muted)' }}>                          {new Date(order.order_creation_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' })}                        </span>                      </td>                    </tr>                  )                })}              </tbody>            </table>          </div>        </div>        {/* Customer credit utilization */}        <div className="erp-card anim-fade-up anim-delay-3">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <Users size={13} color="#a855f7" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Credit Utilization            </span>          </div>          <div style={{ padding: '8px 0' }}>            {sortedCustomers.map((customer) => {            
  const used = Number(customer.current_balance)            
  const limit = Number(customer.maximum_credit_limit)            
  const pct = limit > 0 ? Math.min(100, (used / limit) * 100) : 0            
  const barColor = pct >= 90 ? '#ef4444' : pct >= 70 ? '#f59e0b' : '#22c55e'            
  return (                <div                  key={customer.customer_id}                  style={{ padding: '12px 18px', borderBottom: '1px solid var(--border-dim)' }}                >                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 6 }}>                    <div>                      <div style={{ fontSize: '0.8125rem', fontWeight: 600, color: '#e2eaf5' }}>                        {customer.customer_name}                      </div>                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginTop: 2 }}>                        <StatusBadge status={customer.customer_tier} size="xs" />                        <StatusBadge status={customer.account_status} size="xs" />                      </div>                    </div>                    <div style={{ textAlign: 'right' }}>                      <div className="num" style={{ fontSize: '0.875rem', fontWeight: 700, color: barColor }}>                        {pct.toFixed(0)}%                      </div>                      <div className="num" style={{ fontSize: '0.65rem', color: 'var(--txt-muted)', marginTop: 1 }}>                        €{used.toLocaleString()} / €{limit.toLocaleString()}                      </div>                    </div>                  </div>                  <div className="erp-bar" style={{ height: 4 }}>                    <div                      className="erp-bar-fill"                      style={{ width: `${pct}%`, background: barColor }}                    />                  </div>                </div>              )            })}          </div>        </div>      </div>    </div>  )}
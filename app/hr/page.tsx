import { supabase } from '@/lib/supabase'
import { StatusBadge } from '@/components/ui/StatusBadge'
import { Users, Building2, Calendar, DollarSign } from 'lucide-react'
export const revalidate = 30
async function getHrData() {
  const [{ data: employees }, { data: departments }, { data: timesheets }, { data: payrollManifests }] =    await Promise.all([      supabase        .from('erp_employees')        .select('*, erp_departments(department_name, department_code)')        .order('last_name'),      supabase.from('erp_departments').select('*').order('department_name'),      supabase        .from('erp_timesheets')        .select('*, erp_employees(first_name, last_name)')        .order('date_of_labor', { ascending: false })        .limit(20),      supabase        .from('erp_payroll_manifests')        .select('*')        .order('created_at', { ascending: false })        .limit(5),    ])
  return {    employees: employees ?? [],    departments: departments ?? [],    timesheets: timesheets ?? [],    payrollManifests: payrollManifests ?? [],  }}
export default
async function HrPage() {
  const { employees, departments, timesheets, payrollManifests } = await getHrData()
  const totalPayroll = employees.reduce((s, e) => s + Number(e.annual_base_salary), 0)
  const activeCount = employees.filter((e) => e.employment_status === 'active').length
  const deptStats = departments.map((dept) => {  
  const deptEmployees = employees.filter((e) => e.department_id === dept.department_id)  
  const deptPayroll = deptEmployees.reduce((s, e) => s + Number(e.annual_base_salary), 0)  
  const budgetPct = dept.budget_annual > 0      ? Math.min(100, (deptPayroll / Number(dept.budget_annual)) * 100)      : 0  
  return { ...dept, employeeCount: deptEmployees.length, deptPayroll, budgetPct }  })
  return (    <div style={{ padding: '28px 32px', maxWidth: 1400, margin: '0 auto' }}>      {/* Header */}      <div className="anim-fade-up" style={{ marginBottom: 28 }}>        <div className="label" style={{ marginBottom: 6 }}>HUMAN RESOURCES</div>        <h1 style={{ fontSize: '1.6rem', fontWeight: 700, color: 'var(--txt-primary)', letterSpacing: '-0.02em', margin: 0 }}>          Employee Roster & Payroll        </h1>        <p style={{ fontSize: '0.8125rem', color: 'var(--txt-secondary)', marginTop: 5 }}>          Human workforce management — the HR Agent handles timesheet validation and monthly payroll via pg_cron        </p>      </div>      {/* KPI strip */}      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 14, marginBottom: 22 }}>        {[          { label: 'Total Employees', value: employees.length, color: '#a855f7' },          { label: 'Active Staff', value: activeCount, color: '#22c55e' },          { label: 'Departments', value: departments.length, color: '#3b82f6' },          { label: 'Annual Payroll', value: `€${(totalPayroll / 1000).toFixed(0)}k`, color: '#f59e0b' },        ].map(({ label, value, color }, i) => (          <div key={label} className={`erp-card anim-fade-up anim-delay-${i + 1}`} style={{ padding: '16px 20px', borderColor: `${color}25` }}>            <div className="label" style={{ marginBottom: 8 }}>{label}</div>            <div className="num" style={{ fontSize: '1.6rem', fontWeight: 700, color, letterSpacing: '-0.02em' }}>{value}</div>          </div>        ))}      </div>      <div style={{ display: 'grid', gridTemplateColumns: '1fr 340px', gap: 18, marginBottom: 18 }}>        {/* Employee table */}        <div className="erp-card anim-fade-up anim-delay-2">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <Users size={13} color="#a855f7" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Employee Roster            </span>            <span className="label" style={{ marginLeft: 'auto' }}>{employees.length} RECORDS</span>          </div>          <div style={{ overflowX: 'auto' }}>            <table className="erp-table">              <thead>                <tr>                  <th>Employee</th>                  <th>Department</th>                  <th>Role</th>                  <th>Type</th>                  <th>Status</th>                  <th style={{ textAlign: 'right' }}>Annual Salary</th>                  <th>Hire Date</th>                </tr>              </thead>              <tbody>                {employees.map((emp) => {                
  const dept = (emp as Record<string, unknown>).erp_departments as { department_name: string; department_code: string } | null                
  return (                    <tr key={emp.employee_id}>                      <td>                        <div style={{ fontWeight: 600, fontSize: '0.8125rem', color: '#e2eaf5' }}>                          {emp.first_name} {emp.last_name}                        </div>                        <div style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.6rem', color: 'var(--txt-muted)', marginTop: 1 }}>                          {emp.email}                        </div>                      </td>                      <td>                        <div style={{ display: 'flex', alignItems: 'center', gap: 5 }}>                          <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: '#3b82f6', fontWeight: 700 }}>                            [{dept?.department_code}]                          </span>                          <span style={{ fontSize: '0.75rem', color: 'var(--txt-secondary)' }}>{dept?.department_name}</span>                        </div>                      </td>                      <td>                        <span style={{ fontSize: '0.75rem', color: 'var(--txt-secondary)' }}>{emp.job_title ?? '—'}</span>                      </td>                      <td>                        <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: 'var(--txt-muted)' }}>                          {emp.employment_type.replace(/_/g, ' ')}                        </span>                      </td>                      <td><StatusBadge status={emp.employment_status} size="xs" /></td>                      <td style={{ textAlign: 'right' }}>                        <span className="num" style={{ fontSize: '0.875rem', fontWeight: 600, color: '#22c55e' }}>                          €{Number(emp.annual_base_salary).toLocaleString()}                        </span>                      </td>                      <td>                        <span className="mono" style={{ fontSize: '0.7rem', color: 'var(--txt-muted)' }}>                          {new Date(emp.official_hire_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' })}                        </span>                      </td>                    </tr>                  )                })}              </tbody>            </table>          </div>        </div>        {/* Department budgets */}        <div className="erp-card anim-fade-up anim-delay-3">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <Building2 size={13} color="#3b82f6" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Department Budgets            </span>          </div>          <div style={{ padding: '8px 0' }}>            {deptStats.map((dept) => {            
  const barColor = dept.budgetPct >= 90 ? '#ef4444' : dept.budgetPct >= 70 ? '#f59e0b' : '#3b82f6'            
  return (                <div                  key={dept.department_id}                  style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)' }}                >                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 8 }}>                    <div>                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 3 }}>                        <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: '#3b82f6', fontWeight: 700 }}>                          [{dept.department_code}]                        </span>                        <span style={{ fontSize: '0.8125rem', fontWeight: 600, color: '#e2eaf5' }}>                          {dept.department_name}                        </span>                      </div>                      <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: 'var(--txt-muted)' }}>                        {dept.employeeCount} employee{dept.employeeCount !== 1 ? 's' : ''}                      </span>                    </div>                    <div style={{ textAlign: 'right' }}>                      <div className="num" style={{ fontSize: '0.875rem', fontWeight: 700, color: barColor }}>                        {dept.budgetPct.toFixed(0)}%                      </div>                      <div className="num" style={{ fontSize: '0.62rem', color: 'var(--txt-muted)', marginTop: 1 }}>                        €{(dept.deptPayroll / 1000).toFixed(0)}k / €{(Number(dept.budget_annual) / 1000).toFixed(0)}k                      </div>                    </div>                  </div>                  <div className="erp-bar" style={{ height: 4 }}>                    <div className="erp-bar-fill" style={{ width: `${dept.budgetPct}%`, background: barColor }} />                  </div>                </div>              )            })}          </div>        </div>      </div>      {/* Timesheets + Payroll */}      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 18 }}>        <div className="erp-card anim-fade-up anim-delay-4">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <Calendar size={13} color="#f59e0b" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Recent Timesheets            </span>          </div>          {timesheets.length === 0 ? (            <div style={{ padding: '40px 18px', textAlign: 'center', color: 'var(--txt-muted)', fontSize: '0.8125rem' }}>No timesheets logged yet</div>          ) : (            <table className="erp-table">              <thead>                <tr>                  <th>Employee</th>                  <th>Date</th>                  <th style={{ textAlign: 'right' }}>Hours</th>                  <th style={{ textAlign: 'right' }}>OT</th>                  <th>Approval</th>                </tr>              </thead>              <tbody>                {timesheets.map((ts) => {                
  const emp = (ts as Record<string, unknown>).erp_employees as { first_name: string; last_name: string } | null                
  return (                    <tr key={ts.timesheet_record_id}>                      <td><span style={{ fontSize: '0.8rem' }}>{emp ? `${emp.first_name} ${emp.last_name}` : '—'}</span></td>                      <td><span className="mono" style={{ fontSize: '0.7rem', color: 'var(--txt-muted)' }}>{ts.date_of_labor}</span></td>                      <td style={{ textAlign: 'right' }}><span className="num" style={{ fontSize: '0.875rem', color: '#e2eaf5' }}>{Number(ts.hours_worked).toFixed(1)}</span></td>                      <td style={{ textAlign: 'right' }}><span className="num" style={{ fontSize: '0.8rem', color: Number(ts.overtime_hours) > 0 ? '#f59e0b' : 'var(--txt-muted)' }}>{Number(ts.overtime_hours).toFixed(1)}</span></td>                      <td><StatusBadge status={ts.approval_status} size="xs" /></td>                    </tr>                  )                })}              </tbody>            </table>          )}        </div>        <div className="erp-card anim-fade-up anim-delay-5">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <DollarSign size={13} color="#22c55e" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Payroll Manifests            </span>          </div>          {payrollManifests.length === 0 ? (            <div style={{ padding: '40px 18px', textAlign: 'center' }}>              <div style={{ color: 'var(--txt-muted)', fontSize: '0.8125rem', marginBottom: 8 }}>No payroll runs yet</div>              <div style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: 'var(--txt-muted)' }}>                pg_cron triggers HR Agent on 25th of each month              </div>            </div>          ) : (            <table className="erp-table">              <thead>                <tr>                  <th>Period</th>                  <th style={{ textAlign: 'center' }}>Employees</th>                  <th style={{ textAlign: 'right' }}>Gross Pay</th>                  <th style={{ textAlign: 'right' }}>Net Pay</th>                  <th>Status</th>                </tr>              </thead>              <tbody>                {payrollManifests.map((pm) => (                  <tr key={pm.manifest_id}>                    <td>                      <span className="mono" style={{ fontSize: '0.75rem', color: 'var(--txt-secondary)' }}>                        {pm.pay_period_start} → {pm.pay_period_end}                      </span>                    </td>                    <td style={{ textAlign: 'center' }}>                      <span className="num" style={{ fontSize: '0.8rem' }}>{pm.employee_count}</span>                    </td>                    <td style={{ textAlign: 'right' }}>                      <span className="num" style={{ fontSize: '0.8rem', color: '#f59e0b' }}>€{Number(pm.total_gross_pay).toLocaleString()}</span>                    </td>                    <td style={{ textAlign: 'right' }}>                      <span className="num" style={{ fontSize: '0.875rem', fontWeight: 600, color: '#22c55e' }}>€{Number(pm.total_net_pay).toLocaleString()}</span>                    </td>                    <td><StatusBadge status={pm.status} size="xs" /></td>                  </tr>                ))}              </tbody>            </table>          )}        </div>      </div>    </div>  )}
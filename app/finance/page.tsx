import { supabase } from '@/lib/supabase'
import { StatusBadge } from '@/components/ui/StatusBadge'
import { TrendingUp, BookOpen, ArrowUpRight, ArrowDownRight } from 'lucide-react'
export const revalidate = 30
async function getFinanceData() {
  const [{ data: accounts }, { data: transactions }] = await Promise.all([    supabase.from('erp_accounts').select('*').order('account_code'),    supabase      .from('erp_financial_transactions')      .select('*, erp_agents(display_name, avatar_emoji)')      .order('posted_timestamp', { ascending: false })      .limit(20),  ])
  return { accounts: accounts ?? [], transactions: transactions ?? [] }
}
const CLASSIFICATION_COLORS: Record<string, { color: string; bg: string }> = {  Asset:     { color: '#22c55e', bg: 'rgba(34,197,94,0.1)' },  Liability: { color: '#ef4444', bg: 'rgba(239,68,68,0.1)' },  Equity:    { color: '#a855f7', bg: 'rgba(168,85,247,0.1)' },  Revenue:   { color: '#3b82f6', bg: 'rgba(59,130,246,0.1)' },  Expense:   { color: '#f59e0b', bg: 'rgba(245,158,11,0.1)' },}
export default
async function FinancePage() {
  const { accounts, transactions } = await getFinanceData()  // Group accounts by classification
  const byClass = accounts.reduce((acc, a) => {    if (!acc[a.account_classification]) acc[a.account_classification] = []
    acc[a.account_classification].push(a)
    return acc  }, {} as Record<string, typeof accounts>)
  const classifications = ['Asset', 'Liability', 'Equity', 'Revenue', 'Expense']
  return (    <div style={{ padding: '28px 32px', maxWidth: 1400, margin: '0 auto' }}>      {/* Header */}      <div className="anim-fade-up" style={{ marginBottom: 28 }}>        <div className="label" style={{ marginBottom: 6 }}>FINANCE MODULE</div>        <h1 style={{ fontSize: '1.6rem', fontWeight: 700, color: 'var(--txt-primary)', letterSpacing: '-0.02em', margin: 0 }}>          General Ledger & Accounts        </h1>        <p style={{ fontSize: '0.8125rem', color: 'var(--txt-secondary)', marginTop: 5 }}>          Double-entry accounting with predicate-calculus-enforced journal balance constraints        </p>      </div>      {/* Classification summary */}      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 12, marginBottom: 24 }}>        {classifications.map((cls, i) => {        
  const accs = byClass[cls] ?? []        
  const cfg = CLASSIFICATION_COLORS[cls]        
  return (            <div              key={cls}              className={`erp-card anim-fade-up anim-delay-${i + 1}`}              style={{ padding: '14px 16px', borderColor: `${cfg.color}25` }}            >              <div style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.6rem', fontWeight: 700, letterSpacing: '0.12em', color: cfg.color, textTransform: 'uppercase', marginBottom: 8 }}>                {cls}              </div>              <div className="num" style={{ fontSize: '1.5rem', fontWeight: 700, color: cfg.color, lineHeight: 1 }}>                {accs.length}              </div>              <div style={{ fontSize: '0.7rem', color: 'var(--txt-muted)', marginTop: 4 }}>                accounts              </div>            </div>          )        })}      </div>      <div style={{ display: 'grid', gridTemplateColumns: '1fr 420px', gap: 18 }}>        {/* Chart of Accounts */}        <div className="erp-card anim-fade-up anim-delay-2">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <BookOpen size={13} color="#22c55e" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Chart of Accounts            </span>            <span className="label" style={{ marginLeft: 'auto' }}>{accounts.length} ACCOUNTS</span>          </div>          <div style={{ overflowX: 'auto' }}>            <table className="erp-table">              <thead>                <tr>                  <th>Code</th>                  <th>Account Name</th>                  <th>Classification</th>                  <th>Currency</th>                  <th style={{ textAlign: 'center' }}>Status</th>                </tr>              </thead>              <tbody>                {accounts.map((account) => {                
  const cfg = CLASSIFICATION_COLORS[account.account_classification]                
  return (                    <tr key={account.account_id}>                      <td>                        <span className="num" style={{ fontSize: '0.8rem', fontWeight: 700, color: '#3b82f6', letterSpacing: '0.04em' }}>                          {account.account_code}                        </span>                      </td>                      <td>                        <span style={{ fontSize: '0.8125rem', fontWeight: 500, color: '#e2eaf5' }}>                          {account.account_name}                        </span>                      </td>                      <td>                        <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', padding: '2px 7px', background: cfg.bg, border: `1px solid ${cfg.color}30`, borderRadius: 3, color: cfg.color, fontWeight: 600 }}>                          {account.account_classification}                        </span>                      </td>                      <td>                        <span className="mono" style={{ fontSize: '0.75rem', color: 'var(--txt-secondary)' }}>                          {account.currency_code}                        </span>                      </td>                      <td style={{ textAlign: 'center' }}>                        <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.65rem', color: account.is_active ? '#22c55e' : '#ef4444' }}>                          {account.is_active ? 'ACTIVE' : 'CLOSED'}                        </span>                      </td>                    </tr>                  )                })}              </tbody>            </table>          </div>        </div>        {/* Recent Transactions */}        <div className="erp-card anim-fade-up anim-delay-3">          <div style={{ padding: '13px 18px', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: 8 }}>            <TrendingUp size={13} color="#3b82f6" />            <span style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#e2eaf5' }}>              Recent Transactions            </span>          </div>          {transactions.length === 0 ? (            <div style={{ padding: '40px 18px', textAlign: 'center', color: 'var(--txt-muted)', fontSize: '0.8125rem' }}>              No transactions posted yet            </div>          ) : (            <div>              {transactions.map((tx) => {              
  const agent = (tx as Record<string, unknown>).erp_agents as { display_name: string; avatar_emoji: string } | null              
  const isCredit = tx.source_document_type === 'invoice'              
  return (                  <div                    key={tx.transaction_id}                    style={{                      padding: '12px 18px',                      borderBottom: '1px solid var(--border-dim)',                      transition: 'background 0.1s',                    }}                  >                    <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: 8 }}>                      <div style={{ flex: 1, minWidth: 0 }}>                        <div style={{ fontSize: '0.8rem', fontWeight: 500, color: '#e2eaf5', marginBottom: 3, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>                          {tx.semantic_description}                        </div>                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>                          {agent && (                            <span style={{ fontSize: '0.7rem', color: 'var(--txt-muted)' }}>                              {agent.avatar_emoji} {agent.display_name}                            </span>                          )}                          {tx.source_document_type && (                            <span className="mono" style={{ fontSize: '0.65rem', color: 'var(--txt-muted)' }}>                              · {tx.source_document_type}                            </span>                          )}                        </div>                      </div>                      <div style={{ flexShrink: 0, textAlign: 'right' }}>                        <div style={{ display: 'flex', alignItems: 'center', gap: 4, justifyContent: 'flex-end' }}>                          {isCredit                            ? <ArrowUpRight size={11} color="#22c55e" />                            : <ArrowDownRight size={11} color="#ef4444" />                          }                        </div>                        <div className="mono" style={{ fontSize: '0.65rem', color: 'var(--txt-muted)', marginTop: 2 }}>                          {new Date(tx.posted_timestamp).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}                        </div>                      </div>                    </div>                  </div>                )              })}            </div>          )}        </div>      </div>      {/* Double-entry info */}      <div className="erp-card anim-fade-up anim-delay-5" style={{ marginTop: 18, padding: '14px 20px' }}>        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>          <span className="mono" style={{ fontSize: '0.7rem', color: '#3b82f6', whiteSpace: 'nowrap' }}>            ACCOUNTING RULE          </span>          <div style={{ width: 1, height: 20, background: 'var(--border-mid)' }} />          <code style={{ fontFamily: 'var(--font-ibm-mono, monospace)', fontSize: '0.8rem', color: '#22c55e' }}>            ∀ T ∈ Transactions: Σ(Debits) = Σ(Credits)          </code>          <div style={{ width: 1, height: 20, background: 'var(--border-mid)' }} />          <span style={{ fontSize: '0.75rem', color: 'var(--txt-muted)' }}>            Enforced via PostgreSQL trigger on <code style={{ fontFamily: 'monospace', color: 'var(--txt-secondary)' }}>erp_journal_entries</code> — unbalanced entries raise EXCEPTION before commit          </span>        </div>      </div>    </div>  )}